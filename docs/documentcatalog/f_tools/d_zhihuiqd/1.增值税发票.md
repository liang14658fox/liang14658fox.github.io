:::warning 接口开发规范
1. 分页参数使用默认键值
2. 后端返回字段键值并非前端开发需要，需要字典
3. 日期格式：`yyyymm` 与 `yyyy-mm-dd`
:::

## 0. 异步处理统一规则

1. 首先调用获取当前税款所属期与当期税款所属期统计状态接口获取当前状态
2. 查询异步处理结果

处理类型：

* cxdk：撤销抵扣
* cxqrtj：撤销确认统计
* cxtj：撤销统计
* sqdk：申请抵扣
* sqqrtj：申请确认统计
* sqtj：申请统计

场景描述：

1. 发票勾选/撤销
* 统计状态为0时 判断是否存在申请统计（sqtj）
* 若没有判断是否存在申请/撤销抵扣（sqdk、cxdk）
* 若均没有可以进行申请/撤销勾选操作。

2. 发票申请/撤销统计
* 统计状态为0时 判断是否存在申请统计（sqtj）
* 若没有判断是否存在申请/撤销抵扣（sqdk、cxdk）
* 若没有可以继续操作。
* 统计状态为1时 判断是否存在确认统计（sqqrtj）和撤销统计（cxtj）
* 若没有可以进行撤销统计。

3. 发票申请/撤销确认
* 统计状态为1时 判断是否存在确认统计（sqqrtj）和撤销统计（cxtj）
* 若没有可以进行申请确认
* 统计状态为2时 判断是否存在撤销确认统计（cxqrtj）
* 若没有可以进行撤销确认统计。

## 1. 发票勾选确认企业列表查询

:::tip
从菜单栏点击抵扣类勾选进入的页面，进入页面时自动查询一次该接口。

`查询` `重置` `申报日期刷新` 按钮会调用该接口。

所有需要分页的接口可以不传分页参数，因为分页参数是公共的。
<!-- <div style="width:100%;display: flex;
  justify-content: center;padding:1px;background:white;border-radius:10px;margin-bottom:8px;padding:10px">
<img src="/抵扣类勾选1.PNG" style="height:400px;width:510"/>
</div> -->
:::

* 调用接口：/fpgx/getQylb

* 请求样例：

```json
{
	"gsdm":"公司代码",
	"nsrlx": "纳税人类型"
}
```
* 返回样例：
```json
{
    "code": "0",
    "message": "查询分页成功",
    "data": {
        "records": [
            {
                "gsbm": "公司编码",
                "nsrsbh": "纳税人识别号",
                "nsrmc": "纳税人名称",
                "nsrzt": "纳税人状态",
                "nsrlx": "纳税人类型"
            }
        ],
        “total”: 100,
        “size”: 30,
        “current”: 1,
        “orders”: [],
        “optimizeCountSql”: true,
        “hitCount”: false,
        “countId”: null,
        “maxLimit”: null,
        “searchCount”: true,
        “pages”: 4
    }
}
```

:::warning
首页 上有个下拉列表是查询用户所属公司信息的 接口为：/sjhbdz/SearchGsxxByAll
:::

## 2. 查询异步处理结果

:::tip
在公司表页面点击任何一个公司进入的页面后，自动进入抵扣勾选tabs下的增值税发票页面，会自动调用该接口。

没有设计。
<!-- <div style="width:100%;display: flex;
  justify-content: center;padding:1px;background:white;border-radius:10px;margin-bottom:8px;padding:10px">
<img src="/抵扣类勾选2.PNG" style="height:300px;width:510"/>
</div> -->
:::

* 调用接口：/fpgx/fkztcx

* 处理类型：

1. cxdk：撤销抵扣
2. cxqrtj：撤销确认统计
3. cxtj：撤销统计
4. sqdk：申请抵扣
5. sqqrtj：申请确认统计
6. sqtj：申请统计

* 请求样例：
```json
{
“nsrsbh”: “购买方统一社会信用代码/纳税人识别号”,
“skssq”: “税款所属期” ,
“cllx”: “处理类型”
}
```
* 返回样例：
```json
{
	“code”: “返回状态”,
	“message”: “返回信息”,
	“data”: 
        [{ 
        “nsrsbh”: “纳税人识别号”, 
        “gsbm”: “公司编码”, 
        “skssq”: “税款所属期”, 
        “pclsh”: “批次流水号”,
        “lcclzt”: “流程处理状态”, 
        “lcclmsg”: “流程处理信息”, 
        “cllx”: “处理类型” , 
        “lrr”: “录入人” 
        }]
}
```
## 3. 查询表单获得抵扣发票表格数据

:::tip
点击 `查询` `重置` 按钮会调用该接口。注意分页参数

<!-- <div style="width:100%;display: flex;
  justify-content: center;padding:1px;background:white;border-radius:10px;margin-bottom:8px;padding:10px">
<img src="/抵扣类勾选3.PNG" style="height:300px;width:510"/>
</div> -->
:::

* 调用接口：/fpgx/getDkfplb
* 请求样例：
```json
{
	“gsdm”: “公司代码”,
	“nsrsbh”: “纳税人识别号”,
	“ssq”: “所属期”,
	“gxzt”: “勾选状态”,
	“fply”: “发票来源”,
	“kprqq”: “开票日期起”,
	“kprqz”: “开票日期止”,
	“fpzt”: “发票状态”,
	“pz”: “票种”,
	“znxzmbh”: “转内销证明编号”,
	“qdfphm”: “全电发票号码”,
	“fpdm”: “发票代码”,
	“fphm”: “发票号码”,
	“xfnsrsbh”: “销方纳税人识别号”,
	“xfnsrmc”: “销方纳税人名称”,
	“fpfxdj”: “发票风险等级”,
	“gxrqq”: “勾选日期起”,
	“gxrqz”: “勾选日期止”
}
```
* 返回样例：
```json
{
    “code”: “0”,
    “message”: “查询分页成功”,
    “data”: {
        “records”: [
            {
                “qdfphm”: “全电发票号码”,
                “fpdm”: “发票代码”,
                “fphm”: “发票号码”,
                “kprq”: “开票日期”,
                “pmje”: “金额”,
                “pmse”: “票面税额”,
                “yxdkse”: “有效抵扣税额”,
                “xfnsrmc”: “销方纳税人名称”,
                “xfnsrsbh”: “销方纳税人识别号”,
                “gxzt”: “勾选状态”,
                “fply”: “发票来源”,
                “pz”: “票种”,
                “fpzt”: “发票状态”,
                “hzsdzt”: “红字锁定状态”,
                “gxsj”: “勾选时间”,
                “znxzmbh”: “转内销证明编号”,
                “fpfxdj”: “发票风险等级”
            }
        ],
        “total”: 100,
        “size”: 30,
        “current”: 1,
        “orders”: [],
        “optimizeCountSql”: true,
        “hitCount”: false,
        “countId”: null,
        “maxLimit”: null,
        “searchCount”: true,
        “pages”: 4
    }
}
```


## 3.1  导出查询表单获得的抵扣发票表格数据

:::tip
导出按钮，需要的参数与查询按钮相同。要注意：想导出的是下方的表格，所以点击查询按钮的同时要将当前查询字段复值给隐形变量给导出用，防止参数发生改变。
:::

* 调用接口：/fpgx/downFpdkcxmx
* 请求样例：
```json
{
 “gsdm”: “公司代码”,
 “nsrsbh”: “纳税人识别号”,
 “ssq”: “所属期”,
 “gxzt”: “勾选状态”,
 “fply”: “发票来源”,
 “kprqq”: “开票日期起”,
 “kprqz”: “开票日期止”,
 “fpzt”: “发票状态”,
 “pz”: “票种”,
 “znxzmbh”: “转内销证明编号”,
 “qdfphm”: “全电发票号码”,
 “fpdm”: “发票代码”,
 “fphm”: “发票号码”,
 “xfnsrsbh”: “销方纳税人识别号”,
 “xfnsrmc”: “销方纳税人名称”,
 “fpfxdj”: “发票风险等级”,
 “gxrqq”: “勾选日期起”,
 “gxrqz”: “勾选日期止”
}
```
* 返回样例：
```json
{
    “code”: “0”,
    “message”: “导入成功”
}
```

## 4. 勾选发票清单导入勾选

:::tip
下载《发票抵扣勾选导入模板》之后，将文件上传至该接口。

上传完毕要根据返回信息渲染到dialog上。

调用完该接口后要重新查询一次表格数据。

没有设计下载模板操作。
<!-- <div style="width:100%;display: flex;
  justify-content: center;padding:1px;background:white;border-radius:10px;margin-bottom:8px;padding:10px">
<img src="/抵扣类勾选4-1.PNG" style="height:400px;width:510"/>
</div>
<div style="width:100%;display: flex;
  justify-content: center;padding:1px;background:white;border-radius:10px;margin-bottom:8px;padding:10px">
<img src="/抵扣类勾选4-2.PNG" style="height:400px;width:510"/>
</div> -->
:::

* 调用接口：/fpgx/saveDkfpqd

* 请求样例：post
* 表单提交
1. file:文件
2. gsbm:公司编码
3. nsrsbh:纳税人识别号
4. ssq:所属期

* 返回样例：
```json
{
    “code”: “0”,
    “message”: “导入成功”
}
```
## 5. 提交勾选/撤销勾选

:::tip
勾选表格的复选框之后，点击 `提交勾选` ，点击dialog的 `确认` 按钮后调用的接口。

调用该接口后要重新查询一下表格数据。
<!-- <div style="width:100%;display: flex;
  justify-content: center;padding:1px;background:white;border-radius:10px;margin-bottom:8px;padding:10px">
<img src="/抵扣类勾选5.PNG" style="height:350px;width:510"/>
</div> -->
:::

* 调用接口：/fpgx/saveGxfpxx
* 请求样例：
```json
{
	“gfsbh”: “购买方统一社会信用代码/纳税人识别号”,
	“gxlxDm”: “勾选类型01：申请抵扣 02：撤销抵扣 03：申请不抵扣 04：撤销不抵扣”,
	“fpmx”: [
		{
			“kprq”: “开票日期”,
			“fpdm”: “发票代码”,
			“fphm”: “发票号码”,
			“ckznxzmbh”: “出口转内销证明编号”,
			“fplx”: “发票类型”,
			“bdklx”: “不抵扣类型”,
			“bdkyy”: “不抵扣原因”
		}
	]
}
```
* 返回样例：
```json
{
	“code”: “返回状态”,
	“message”: “返回信息”,
	“data”: {
		“returncode”: “返回码”,
		“returnmsg”: “返回信息”,
		“pclsh”: “批次流水号”,
		“fpmx”: [
			{
				“kprq”: “开票日期”,
				“fpdm”: “发票代码”,
				“fphm”: “发票号码”,
				“ckznxzmbh”: “出口转内销证明编号”,
				“sczt”: “上传状态”,
            	“errormsg”: “错误信息”
			}
		]
	}
}
```



## 2. 获取当前税款所属期与当期税款所属期 统计状态

:::tip
点击纳税人识别号进入到操作页面之后，会返回税款所属期和状态status ：00 01 02，也需要存到隐形变量中。
* 01可勾选发票，可以申请统计，
* 02代表已经申请统计的状态，直接跳转到step2，
* 03，代表已经确认，只能撤销确认（但是没有设计撤销确认按钮）
:::

* 调用接口：/fpgx/getDqskssq
* 请求样例：
```json
{
 “gfsbh”:” 购买方统一社会信用代码/纳税人识别号”
}
```
* 返回样例：
```json
{
    “code”: “返回码”,
    “message”: “返回信息”,
    “data”: {
            “returncode”: “返回码”,
            “returnmsg”: “返回信息”,
            “skssq”: “税款所属期”,
            “zt”: “统计状态”
    }
}
```

## 3. 抵扣详情
统计确认-当前属期数据统计返回的表格中，点击份数弹出表格调用的接口。

:::tip
设计完毕
:::


